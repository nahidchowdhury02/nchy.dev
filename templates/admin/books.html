{% extends "layouts/admin.html" %}

{% block title %}Books Management{% endblock %}
{% block header_title %}Books Management{% endblock %}

{% block content %}
  <section class="card form-card">
    <h2>Add Book</h2>
    <form method="post" action="{{ url_for('admin.books') }}" class="form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="form-field form-field-full">
        <label for="title">Title</label>
        <input id="title" type="text" name="title" required />
      </div>

      <div class="form-field">
        <label for="slug">Slug (optional)</label>
        <input id="slug" type="text" name="slug" />
      </div>

      <div class="form-field">
        <label for="author">Authors (comma)</label>
        <input id="author" type="text" name="author" />
      </div>

      <div class="form-field">
        <label for="subtitle">Subtitle</label>
        <input id="subtitle" type="text" name="subtitle" />
      </div>

      <div class="form-field">
        <label for="first_publish_year">Year</label>
        <input id="first_publish_year" type="number" name="first_publish_year" />
      </div>

      <div class="form-field form-field-full">
        <label for="cover_url">Cover URL</label>
        <input id="cover_url" type="url" name="cover_url" />
      </div>

      <div class="form-field form-field-full">
        <label for="description">Description</label>
        <textarea id="description" name="description" rows="5"></textarea>
      </div>

      <div class="form-field form-field-full">
        <button type="submit">Add Book</button>
      </div>
    </form>
  </section>

  <section class="card form-card">
    <h2>World Library Search</h2>
    <form method="get" action="{{ url_for('admin.books') }}" class="inline-form">
      <input type="text" name="external_q" value="{{ external_query }}" placeholder="search by ISBN or title" />
      <button type="submit">Search</button>
    </form>
    {% if external_query %}
      <p class="small-note">Open Library results: {{ external_books|length }}</p>
    {% endif %}
  </section>

  {% if external_query %}
    <section class="card-grid" aria-label="Open Books search results">
      {% for item in external_books %}
        <article class="card book-card">
          <figure class="preview-card">
            <img src="{{ item.cover_url or url_for('static', filename='images/missing book cover.png') }}" alt="cover of {{ item.title }}" loading="lazy" />
          </figure>
          <h3>{{ item.title }}</h3>
          <p class="book-meta">Author(s): {{ item.author or '-' }}</p>
          <p class="book-meta">Year: {{ item.first_publish_year or '-' }}</p>
          <p class="book-meta">ISBN: {{ item.source_isbn or '-' }}</p>
          <form method="post" action="{{ url_for('admin.books_import') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="external_q" value="{{ external_query }}" />
            <input type="hidden" name="title" value="{{ item.title }}" />
            <input type="hidden" name="subtitle" value="{{ item.subtitle }}" />
            <input type="hidden" name="author" value="{{ item.author }}" />
            <input type="hidden" name="first_publish_year" value="{{ item.first_publish_year }}" />
            <input type="hidden" name="cover_url" value="{{ item.cover_url }}" />
            <input type="hidden" name="description" value="{{ item.description }}" />
            <input type="hidden" name="source_open_key" value="{{ item.source_open_key }}" />
            <input type="hidden" name="source_isbn" value="{{ item.source_isbn }}" />
            <button type="submit">Add</button>
          </form>
        </article>
      {% else %}
        <article class="card"><p>No results found for that ISBN or title.</p></article>
      {% endfor %}
    </section>
  {% endif %}

  <section class="card form-card">
    <h2>Books in Library</h2>
    <form method="get" action="{{ url_for('admin.books') }}" class="inline-form">
      <input type="text" name="q" value="{{ query }}" placeholder="Search by title or author" />
      <button type="submit">Search</button>
    </form>
    <p class="small-note">Showing: {{ books|length }}</p>
  </section>

  <section class="books-cards" aria-label="Books mobile cards">
    {% for book in books %}
      <article class="card book-card">
        <figure class="preview-card">
          <img src="{{ book.cover_url or url_for('static', filename='images/missing book cover.png') }}" alt="cover of {{ book.title }}" loading="lazy" />
        </figure>
        <h3>{{ book.title }}</h3>
        <p class="book-meta">Author(s): {{ book.author or '-' }}</p>
        <p class="book-meta">Year: {{ book.first_publish_year or '-' }}</p>
        <p class="book-meta">Slug: {{ book.slug }}</p>
        <a class="btn-link" href="{{ url_for('admin.book_edit', book_id=book.id) }}">Edit</a>
        <form method="post" action="{{ url_for('admin.book_delete', book_id=book.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="q" value="{{ query }}" />
          <button type="submit">delete</button>
        </form>
      </article>
    {% else %}
      <article class="card"><p>No books found.</p></article>
    {% endfor %}
  </section>

  <section class="books-table card" aria-label="Books desktop table">
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Author(s)</th>
          <th>Year</th>
          <th>Slug</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        {% for book in books %}
          <tr>
            <td>{{ book.title }}</td>
            <td>{{ book.author }}</td>
            <td>{{ book.first_publish_year or '-' }}</td>
            <td>{{ book.slug }}</td>
            <td><a href="{{ url_for('admin.book_edit', book_id=book.id) }}">Edit</a></td>
            <td>
              <form method="post" action="{{ url_for('admin.book_delete', book_id=book.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="q" value="{{ query }}" />
                <button type="submit">delete</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6">No books found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
