{% extends "layouts/admin.html" %}

{% block title %}Reading Management{% endblock %}
{% block header_title %}Reading Management{% endblock %}

{% block content %}
  <section class="card form-card">
    <h2>Add from Library</h2>
    <form method="get" action="{{ url_for('admin.reading') }}" class="inline-form">
      <input type="text" name="q" value="{{ query }}" placeholder="Search by title or author" />
      <button type="submit">Search</button>
    </form>
    <p class="small-note">Library matches: {{ books|length }}</p>

    <form method="post" action="{{ url_for('admin.reading') }}" class="form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="q" value="{{ query }}" />

      <div class="form-field form-field-full">
        <label for="book_id">Book</label>
        <select id="book_id" name="book_id" required>
          <option value="">Choose from library</option>
          {% for book in books %}
            <option value="{{ book.id }}">{{ book.title }}{% if book.author %} - {{ book.author }}{% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-field form-field-full">
        <label for="reading_note">Small Reading Note</label>
        <textarea id="reading_note" name="reading_note" rows="3" maxlength="280" placeholder="Quick thought, progress, or reminder..."></textarea>
      </div>

      <div class="form-field form-field-full">
        <button type="submit">Add to Reading List</button>
      </div>
    </form>
  </section>

  <section>
    <h2 class="section-title">Current Reading</h2>
    <div class="card-grid" aria-label="Current reading list">
      {% for item in entries %}
        <article class="card admin-item">
          {% if item.book %}
            <h3>{{ item.book.title }}</h3>
            <p class="book-meta">{{ item.book.author or 'Unknown author' }}</p>
            <p class="book-meta">{{ item.book.first_publish_year or 'Year unknown' }}</p>
          {% else %}
            <h3>Missing book</h3>
            <p class="small-note">Book no longer exists in library.</p>
          {% endif %}

          <p class="small-note">Added {{ item.created_at|pretty_date }}</p>

          <form method="post" action="{{ url_for('admin.reading_update', entry_id=item.id) }}" class="form-grid">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="q" value="{{ query }}" />
            <div class="form-field form-field-full">
              <label for="reading_note_{{ item.id }}">Small Reading Note</label>
              <textarea id="reading_note_{{ item.id }}" name="reading_note" rows="3" maxlength="280" placeholder="Add a short note...">{{ item.reading_note }}</textarea>
            </div>
            <div class="form-field form-field-full">
              <button type="submit">Save Note</button>
            </div>
          </form>

          <form method="post" action="{{ url_for('admin.reading_delete', entry_id=item.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="q" value="{{ query }}" />
            <button type="submit">Mark as Completed</button>
          </form>
        </article>
      {% else %}
        <article class="card"><p>No books in the reading list yet.</p></article>
      {% endfor %}
    </div>
  </section>
{% endblock %}
