{% extends "layouts/admin.html" %}

{% block title %}Manage Notes{% endblock %}
{% block header_title %}Manage Notes{% endblock %}

{% block content %}
  <section class="card form-card">
    <h2>Add Entry</h2>
    <form method="post" enctype="multipart/form-data" action="{{ url_for('admin.notes') }}" class="form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="form-field">
        <label for="kind">Kind</label>
        <select id="kind" name="kind">
          <option value="note">Note</option>
          <option value="log">Log</option>
        </select>
      </div>

      <div class="form-field">
        <label for="title">Title</label>
        <input id="title" type="text" name="title" placeholder="short title" />
      </div>

      <div class="form-field form-field-full">
        <label for="body">Body</label>
        <textarea id="body" name="body" rows="8" placeholder="Write your entry..."></textarea>
      </div>

      <div class="form-field form-field-full">
        <label for="upload_file">Or file (.txt/.md/.log)</label>
        <input id="upload_file" type="file" name="upload_file" accept=".txt,.md,.log,text/plain" />
      </div>

      <div class="form-field form-field-full">
        <label for="audio_file">Or audio file</label>
        <input id="audio_file" type="file" name="audio_file" accept="audio/*,.mp3,.wav,.m4a,.ogg,.aac,.flac,.webm" />
      </div>

      <div class="form-field">
        <label><input type="checkbox" name="is_published" value="1" checked /> Publish to /notes</label>
      </div>

      <div class="form-field form-field-full">
        <button type="submit">Save</button>
      </div>
    </form>
  </section>

  <section>
    <h2 class="section-title">Saved Entries</h2>
    <div class="card-grid" aria-label="Saved notes">
      {% for entry in entries %}
        <article class="card admin-item">
          <form method="post" action="{{ url_for('admin.notes_update', entry_id=entry.id) }}" enctype="multipart/form-data" class="form-grid">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <div class="form-field">
              <label>Kind</label>
              <select name="kind">
                <option value="note" {% if entry.kind == 'note' %}selected{% endif %}>Note</option>
                <option value="log" {% if entry.kind == 'log' %}selected{% endif %}>Log</option>
              </select>
            </div>

            <div class="form-field">
              <label>Title</label>
              <input type="text" name="title" value="{{ entry.title }}" required />
            </div>

            <div class="form-field form-field-full">
              <label>Body</label>
              <textarea name="body" rows="8">{{ entry.body }}</textarea>
            </div>

            <div class="form-field form-field-full">
              <label>Replace from file (.txt/.md/.log)</label>
              <input type="file" name="upload_file" accept=".txt,.md,.log,text/plain" />
            </div>

            <div class="form-field form-field-full">
              <label>Attach/replace audio file</label>
              <input type="file" name="audio_file" accept="audio/*,.mp3,.wav,.m4a,.ogg,.aac,.flac,.webm" />
            </div>

            {% if entry.audio_url %}
              <div class="form-field form-field-full">
                <label>Current audio</label>
                <audio controls preload="none" src="{{ entry.audio_url }}"></audio>
              </div>
            {% endif %}

            <div class="form-field">
              <label><input type="checkbox" name="is_published" value="1" {% if entry.is_published %}checked{% endif %} /> Publish to /notes</label>
            </div>

            <div class="form-field form-field-full">
              <button type="submit">Save</button>
            </div>
          </form>
          <form method="post" action="{{ url_for('admin.notes_delete', entry_id=entry.id) }}" onsubmit="return confirm('Delete this note?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit">delete</button>
          </form>
          <p class="small-note">
            Published: {{ entry.is_published }} | {{ entry.created_at|pretty_date }}
            {% if entry.source_filename %}| src: {{ entry.source_filename }}{% endif %}
            {% if entry.audio_source_filename %}| audio: {{ entry.audio_source_filename }}{% endif %}
          </p>
        </article>
      {% else %}
        <article class="card"><p>No entries yet.</p></article>
      {% endfor %}
    </div>
  </section>
{% endblock %}
