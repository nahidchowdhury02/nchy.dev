{% extends "layouts/admin.html" %}

{% block title %}Gallery Management{% endblock %}
{% block header_title %}Gallery Management{% endblock %}

{% block content %}
  <section class="card form-card">
    <h2>Add Gallery Item</h2>
    <form method="post" action="{{ url_for('admin.gallery') }}" enctype="multipart/form-data" class="form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="form-field">
        <label for="category">Category</label>
        <select id="category" name="category">
          <option value="sketches">sketches</option>
          <option value="moments">moments</option>
          <option value="all">all</option>
        </select>
      </div>

      <div class="form-field">
        <label for="title">Title</label>
        <input id="title" type="text" name="title" required />
      </div>

      <div class="form-field form-field-full">
        <label for="caption">Caption</label>
        <textarea id="caption" name="caption" rows="3"></textarea>
      </div>

      <details class="form-field form-field-full">
        <summary>Advanced Media Settings</summary>

        <div class="form-grid">
          <div class="form-field form-field-full">
            <label for="image">Image file</label>
            <input id="image" type="file" name="image" accept="image/*" />
          </div>

          <div class="form-field form-field-full">
            <label for="create-image-url">Image URL</label>
            <p class="small-note">Optional. Usually auto-filled from image upload.</p>
            <input id="create-image-url" type="text" name="image_url" />
          </div>

          <div class="form-field form-field-full">
            <label for="create-public-id">Storage ID</label>
            <input id="create-public-id" type="text" name="storage_public_id" />
          </div>

          <div class="form-field">
            <label for="sort_order">Sort</label>
            <input id="sort_order" type="number" name="sort_order" value="0" />
          </div>

          <div class="form-field">
            <label><input type="checkbox" name="is_published" value="1" checked /> Published</label>
          </div>
        </div>
      </details>

      <div class="form-field form-field-full">
        <button type="submit">Create</button>
      </div>
    </form>
  </section>

  <section>
    <h2 class="section-title">Saved Items</h2>
    <div class="card-grid" aria-label="Saved gallery items">
      {% for item in items %}
        <article class="card admin-item">
          <form method="post" action="{{ url_for('admin.gallery_update', item_id=item.id) }}" enctype="multipart/form-data" class="form-grid">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            {% if item.image_url %}
              <div class="form-field form-field-full">
                <label>Current image</label>
                <a class="admin-image-preview-link" href="{{ item.image_url }}" target="_blank" rel="noopener noreferrer">
                  <img class="admin-image-preview" src="{{ item.image_url }}" alt="{{ item.title or 'gallery image' }}" loading="lazy" />
                </a>
              </div>
            {% endif %}

            <div class="form-field">
              <label>Category</label>
              <select name="category">
                <option value="sketches" {% if item.category == 'sketches' %}selected{% endif %}>Sketches</option>
                <option value="moments" {% if item.category == 'moments' %}selected{% endif %}>Moments</option>
                <option value="all" {% if item.category == 'all' %}selected{% endif %}>All</option>
              </select>
            </div>

            <div class="form-field">
              <label>Title</label>
              <input type="text" name="title" value="{{ item.title }}" required />
            </div>

            <div class="form-field form-field-full">
              <label>Caption</label>
              <textarea name="caption" rows="3">{{ item.caption }}</textarea>
            </div>

            <details class="form-field form-field-full">
              <summary>Advanced Media Settings</summary>

              <div class="form-grid">
                <div class="form-field form-field-full">
                  <label>Replace image file</label>
                  <input type="file" name="image" accept="image/*" />
                </div>

                <div class="form-field form-field-full">
                  <label>Image URL</label>
                  <input type="text" name="image_url" value="{{ item.image_url }}" />
                </div>

                <div class="form-field form-field-full">
                  <label>Storage ID</label>
                  <input type="text" name="storage_public_id" value="{{ item.storage_public_id or item.cloudinary_public_id }}" />
                </div>

                <div class="form-field">
                  <label>Sort</label>
                  <input type="number" name="sort_order" value="{{ item.sort_order }}" />
                </div>

                <div class="form-field">
                  <label><input type="checkbox" name="is_published" value="1" {% if item.is_published %}checked{% endif %} /> Published</label>
                  <p class="small-note">Status: {% if item.is_published %}Active{% else %}Archived{% endif %}</p>
                </div>
              </div>
            </details>

            <div class="form-field form-field-full">
              <button type="submit">Save</button>
            </div>
          </form>

          <div class="item-actions">
            {% if item.is_published %}
              <form method="post" action="{{ url_for('admin.gallery_archive', item_id=item.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="category" value="{{ selected_category }}" />
                <button type="submit">archive</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('admin.gallery_unarchive', item_id=item.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="category" value="{{ selected_category }}" />
                <button type="submit">unarchive</button>
              </form>
            {% endif %}

            <form method="post" action="{{ url_for('admin.gallery_delete', item_id=item.id) }}" onsubmit="return confirm('Remove this item?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="category" value="{{ selected_category }}" />
              <button type="submit">Remove</button>
            </form>
          </div>
        </article>
      {% else %}
        <article class="card"><p>No items yet.</p></article>
      {% endfor %}
    </div>
  </section>
{% endblock %}
